<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëÅÔ∏è Eye Gaze UI (Server Driven)</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .header { text-align: center; padding: 30px 20px; background: rgba(0,0,0,0.2); }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { color: rgba(255,255,255,0.7); }
        .status-bar { display: flex; justify-content: center; gap: 30px; padding: 15px; background: rgba(0,0,0,0.3); font-size: 14px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4757; }
        .status-dot.active { background: #7bed9f; }
        .main { padding: 40px 20px; max-width: 1000px; margin: 0 auto; position: relative; }
        .control-panel { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .control-btn { padding: 12px 24px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 30px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .control-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .control-btn.primary { background: #7bed9f; color: #1e3c72; border-color: #7bed9f; }
        .action-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px; }
        .action-card { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 40px 30px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .action-card:hover { background: rgba(255,255,255,0.12); transform: translateY(-5px); }
        .action-card.gaze-active { border-color: #7bed9f; box-shadow: 0 0 30px rgba(123, 237, 159, 0.3); transform: scale(1.02); }
        .action-card.triggered { background: #7bed9f !important; color: #1e3c72 !important; transform: scale(0.95); }
        .action-card.triggered .action-icon, .action-card.triggered .action-label, .action-card.triggered .action-hint { color: #1e3c72 !important; }
        .action-icon { font-size: 48px; margin-bottom: 15px; }
        .action-label { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .action-hint { font-size: 12px; color: rgba(255,255,255,0.5); }
        .instructions { text-align: center; padding: 30px; color: rgba(255,255,255,0.6); font-size: 14px; line-height: 1.8; }
        #gaze-cursor { position: fixed; width: 16px; height: 16px; border: 2px solid #7bed9f; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); display: none; z-index: 9999; box-shadow: 0 0 12px rgba(123,237,159,0.5); }
        #calib-point { position: fixed; width: 24px; height: 24px; background: #ff4757; border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 9998; box-shadow: 0 0 18px rgba(255,71,87,0.6); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üëÅÔ∏è Eye Gaze (Server Driven)</h1>
        <p>Look at a card for 1.5s to trigger it. Start/Stop below.</p>
    </div>
    <div class="status-bar">
        <div class="status-item"><span class="status-dot" id="gaze-status"></span><span>Eye Tracking</span></div>
    </div>
    <div class="main">
        <div class="control-panel">
            <button class="control-btn primary" id="start-btn">‚ñ∂Ô∏è Start Tracking</button>
            <button class="control-btn" id="stop-btn" disabled>‚èπ Stop</button>
        </div>
        <div class="action-grid">
            <div class="action-card gaze-target" data-action="select">
                <div class="action-icon">‚úÖ</div>
                <div class="action-label">Select</div>
                <div class="action-hint">Gaze 1.5s to trigger</div>
            </div>
            <div class="action-card gaze-target" data-action="back">
                <div class="action-icon">‚Ü©Ô∏è</div>
                <div class="action-label">Back</div>
                <div class="action-hint">Gaze 1.5s to trigger</div>
            </div>
            <div class="action-card gaze-target" data-action="scroll">
                <div class="action-icon">‚¨áÔ∏è</div>
                <div class="action-label">Scroll</div>
                <div class="action-hint">Gaze 1.5s to trigger</div>
            </div>
            <div class="action-card gaze-target" data-action="home">
                <div class="action-icon">üè†</div>
                <div class="action-label">Home</div>
                <div class="action-hint">Gaze 1.5s to trigger</div>
            </div>
        </div>
        <div class="instructions">
            <p>üëÅÔ∏è Look at any card for 1.5 seconds to activate it.</p>
            <p>‚öôÔ∏è If tracking seems stuck, press Stop and Start again.</p>
        </div>
    </div>
    <div id="gaze-cursor"></div>
    <div id="calib-point"></div>

    <script>
        const socket = io();
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusDot = document.getElementById('gaze-status');
        const cursor = document.getElementById('gaze-cursor');
        const calibPoint = document.getElementById('calib-point');
        const cards = Array.from(document.querySelectorAll('.gaze-target'));

        const DWELL_TIME = 1500;
        const TOLERANCE = 40;
        let currentTarget = null;
        let dwellStart = null;

        startBtn.addEventListener('click', () => {
            socket.emit('start_gaze');
            startBtn.disabled = true;
            stopBtn.disabled = false;
        });

        stopBtn.addEventListener('click', () => {
            socket.emit('stop_gaze');
            resetGazeUI();
        });

        socket.on('connect', () => statusDot.classList.add('active'));
        socket.on('disconnect', () => statusDot.classList.remove('active'));

        function resetGazeUI() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            cursor.style.display = 'none';
            calibPoint.style.display = 'none';
            clearTargets();
            currentTarget = null;
            dwellStart = null;
        }

        function clearTargets() {
            cards.forEach(c => c.classList.remove('gaze-active'));
        }

        function triggerAction(action) {
            const card = document.querySelector(`[data-action="${action}"]`);
            if (!card) return;
            card.classList.add('triggered');
            setTimeout(() => card.classList.remove('triggered'), 500);
            switch(action) {
                case 'select': console.log('Selected'); break;
                case 'back': console.log('Back'); break;
                case 'scroll': window.scrollBy({ top: 300, behavior: 'smooth' }); break;
                case 'home': window.scrollTo({ top: 0, behavior: 'smooth' }); break;
            }
        }

        function handleGaze(x, y) {
            let target = null;
            for (const card of cards) {
                const rect = card.getBoundingClientRect();
                const inBounds = (
                    x >= rect.left - TOLERANCE && x <= rect.right + TOLERANCE &&
                    y >= rect.top - TOLERANCE && y <= rect.bottom + TOLERANCE
                );
                if (inBounds) { target = card; break; }
            }

            if (target !== currentTarget) {
                currentTarget = target;
                dwellStart = target ? performance.now() : null;
                clearTargets();
                if (target) target.classList.add('gaze-active');
                return;
            }

            if (target && dwellStart) {
                const elapsed = performance.now() - dwellStart;
                if (elapsed >= DWELL_TIME) {
                    triggerAction(target.dataset.action);
                    dwellStart = performance.now(); // reset to avoid rapid repeats
                }
            }
        }

        socket.on('gaze_data', (data) => {
            if (data.calibrating) {
                statusDot.classList.remove('active');
                cursor.style.display = 'none';
                if (data.calib_point) {
                    calibPoint.style.display = 'block';
                    calibPoint.style.left = (data.calib_point.x * 100) + '%';
                    calibPoint.style.top = (data.calib_point.y * 100) + '%';
                }
                return;
            }

            statusDot.classList.add('active');
            calibPoint.style.display = 'none';
            cursor.style.display = 'block';

            const x = data.x * window.innerWidth;
            const y = data.y * window.innerHeight;
            cursor.style.left = `${x}px`;
            cursor.style.top = `${y}px`;

            handleGaze(x, y);
        });
    </script>
</body>
</html>
